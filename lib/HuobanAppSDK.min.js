!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("HuobanAppSDK",[],t):"object"==typeof exports?exports.HuobanAppSDK=t():e.HuobanAppSDK=t()}(this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){if(e&&w[e])return new w[e];throw new Error("unknown client type")}function s(e,t){return t||(t=b?"android":g||m?"ios":"browser"),P.client[t]||(P.client[t]=r(t)),e&&P.client[t].on(e),P.client[t]}function a(e){return P.host||(P.host=new _["default"],P.host.init()),e&&P.host.on(e),P.host}Object.defineProperty(t,"__esModule",{value:!0}),t.isPC=t.isMobile=t.isIPad=t.isIPhone=t.isAndroid=void 0,t.client=s,t.host=a;var u=n(1),c=o(u),l=n(2),f=i(l),d=n(8),p=i(d),h=n(9),v=i(h),y=n(10),_=i(y),b=t.isAndroid=c.isAndroid,g=t.isIPhone=c.isIPhone,m=t.isIPad=c.isIPad,P=(t.isMobile=c.isMobile,t.isPC=c.isPC,{client:{}}),w={android:v["default"],ios:p["default"],browser:f["default"]}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=navigator.userAgent,i=t.isAndroid=!!n.match(/(Android);?[\s\/]+([\d.]+)?/),o=t.isIPad=!!n.match(/(iPad).*OS\s([\d_]+)/),r=t.isIPhone=!o&&!!n.match(/(iPhone\sOS)\s([\d_]+)/),s=t.isMobile=i||r||o;t.isPC=!s,t.HB_HOST="*",t.MSG_TYPES={CONNECT:"$connect$",DISCONNECT:"$disconnect$",CLOSE:"$close$",PING:"$ping$",BROADCAST:"broadcast"}},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=function _(e,t,n){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,t);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:_(o,t,n)}if("value"in i)return i.value;var r=i.get;if(void 0!==r)return r.call(n)},l=n(3),f=i(l),d=n(4),p=n(1),h=n(5),v=i(h),y=function(e){function t(){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"init",value:function(e){var t=(0,f["default"])();if(window.parent===window)return(0,d.delay)(function(e){t.reject({message:"无法找到宿主环境"})}),t.promise;if(!window.MessageChannel)return(0,d.delay)(function(e){t.reject({message:"您的浏览器不支持 MessageChannel"})}),t.promise;if(this._ticket&&this._user)return t.resolve({ticket:this._ticket,user:this._user,app:this._table,table:this._table,version:this._version}),t.promise;this._id=this._unique_id("c_",8);var n=new MessageChannel;return this.port=n.port1,this.port.onmessage=this.handleMessage.bind(this),window.parent.postMessage(p.MSG_TYPES.CONNECT+":"+e+":"+this._id,p.HB_HOST,[n.port2]),this._init(e)}},{key:"_send",value:function(e,t,n){var i={action:e};t&&(i.data=t),n&&(i.id=n),this.port.postMessage(i)}},{key:"_processMessage",value:function(e){var t=e.data;switch(t.action){case p.MSG_TYPES.CONNECT:return t.data.error?(this.emit("error",a({},t.data.error,{type:"connect"})),this.emit("error.connect",t.data.error)):this.connect.resolve(t.data.result),!1;case p.MSG_TYPES.CLOSE:return this.destroy(),!1;case p.MSG_TYPES.PING:return this.push(p.MSG_TYPES.PING),!1}}},{key:"handleWindowBeforeUnload",value:function(e){this._disconnect()}},{key:"_disconnect",value:function(){this.push(p.MSG_TYPES.DISCONNECT)}},{key:"destroy",value:function(){c(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.port&&(this._disconnect(),this.port.close(),this.port=null)}}]),t}(v["default"]);t["default"]=y,e.exports=t["default"]},function(e,t,n){function i(){var e,t,n=new Promise(function(n,i){e=n,t=i});return{promise:n,resolve:e,reject:t}}var o;o=function(){return i}.call(t,n,t,e),!(void 0!==o&&(e.exports=o))},function(e,t){"use strict";function n(e){var t={key:e.field||e.key};return e.query||(e.query={}),"created_by"==e.key?t.values=e.query["in"]:"create_on"==e.key?t.values=o({},e.query):(s(e.query["in"])?c(e.query["in"][0])&&"myself"!=e.query["in"][0]?t.keywords=e.query["in"]:t.values=e.query["in"]:t.values=o({},e.query),u(e.query.em)&&(t.is_set=!e.query.em),e.query.in_field&&(t.fields=e.query.in_field),s(e.query.inc)&&(t.values=e.query.inc)),t}function i(e){var t={field:e.key,query:{}};return"created_by"==e.key?t.query["in"]=e.values:"create_on"==e.key?t.query=o({},e.values):(a(e.values)?t.query=o({},e.values):s(e.values)&&(t.query["in"]=e.values),e.keywords&&s(e.keywords)&&e.keywords.length&&(t.query["in"]=e.keywords),e.is_set!==!0&&e.is_set!==!1||(t.query.em=!e.is_set),e.fields&&(t.query.in_field=e.fields),s(e.within)&&(t.query.inc=e.within)),t}Object.defineProperty(t,"__esModule",{value:!0});var o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r=Object.prototype.toString,s=(t.delay=function(e,t){return setTimeout(e,t||0)},t.isArray=function(e){return Array.isArray?Array.isArray(e):"[object Array]"===r.call(e)}),a=t.isObject=function(e){return"[object Object]"===r.call(e)},u=t.isBool=function(e){return"[object Boolean]"===r.call(e)},c=t.isString=function(e){return"[object String]"===r.call(e)};t.cvFiltersToV1=function l(e){var t=Object.keys(e),i={};return t.forEach(function(t){a(e[t])?i[t]=l(e[t]):s(e[t])&&(i[t]=e[t].map(n))}),i},t.cvFiltersToV2=function f(e){var t=Object.keys(e),n={};return t.forEach(function(t){a(e[t])?n[t]=f(e[t]):s(e[t])&&(n[t]=e[t].map(i))}),n}},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=n(3),l=i(c),f=n(1),d=n(4),p=n(6),h=i(p),v=function(e){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n._ticket=null,n._user=null,n._table=null,n._version=null,n}return s(t,e),u(t,[{key:"init",value:function(e){return(0,l["default"])().promise}},{key:"openWebPage",value:function(e,t){this.push("openWebPage",{url:e,title:t})}},{key:"closeWebPage",value:function(){this.push("closeWebPage")}},{key:"setTitle",value:function(e){this.push("setTitle",{title:e})}},{key:"setNavigationBarVisibility",value:function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];this.push("setNavigationBarVisibility",{is_visible:e})}},{key:"setBottomToolBarVisibility",value:function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];this.push("setBottomToolBarVisibility",{is_visible:e})}},{key:"broadcast",value:function(e,t){this.push(f.MSG_TYPES.BROADCAST,t?{action:e,data:t}:{action:e})}},{key:"openUserProfile",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=arguments[2],i={placement:"bottom"};t=a({},i,t,{user_id:e}),n&&f.isPC&&(t.ePos=this._getEventPosition(n)),this.push("openUserProfile",t)}},{key:"getTableData",value:function(e){return this.send("getTableData",{table_id:e})}},{key:"getAppData",value:function(e){return this.getTableData(e)}},{key:"getSpaceMembers",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return this.send("getSpaceMembers",e)}},{key:"openFilter",value:function(e,t,n,i,o){var r={table_id:e.app_id||e.table_id,space_id:e.space_id};t&&(r.filters=(0,d.cvFiltersToV1)(t)),n&&("function"==typeof n?i=n:n>0&&(r.viewId=parseInt(n,10)));var s=void 0;return i&&(s=function(e){e.filters&&(e.filters=(0,d.cvFiltersToV2)(e.filters)),i(e)}),o&&f.isPC&&(r.ePos=this._getEventPosition(o)),this.send("openFilter",r,null,s)}},{key:"openItemDiff",value:function(e,t,n){var i=arguments.length<=3||void 0===arguments[3]?{}:arguments[3],o=a({},i,{item_id:parseInt(e,10),from_revision_id:parseInt(t,10),to_revision_id:parseInt(n,10),field_id:parseInt(i.field_id,10)});o.field_id&&!o.field_name&&this._table&&this._table.fields.forEach(function(e){if(e.field_id==o.field_id)return o.field_name=e.name,!1}),this.push("openItemDiff",o)}},{key:"openItemDetail",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=a({},t,{item_id:parseInt(e,10)});this.push("openItemDetail",n)}},{key:"openItemList",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.push("openItemList",e)}},{key:"openUserPicker",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments[1],n=arguments[2],i={multi:!1,required:!1,title:"选择成员",placement:"right-bottom",width:300};return e=a({},i,e),n&&f.isPC&&(e.ePos=this._getEventPosition(n)),this.send("openUserPicker",e,null,t)}},{key:"openDatePicker",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments[1],n=arguments[2],i={type:"date",placement:"right-bottom"};return e=a({},i,e),n&&f.isPC&&(e.ePos=this._getEventPosition(n)),this.send("openDatePicker",e,null,t)}},{key:"openShare",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments[1],n=arguments[2],i={title:"",content:"",url:""};return e=a({},i,e),n&&f.isPC&&(e.ePos=this._getEventPosition(n)),this.send("openShare",e,null,t)}},{key:"openAttachment",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];arguments[2];return f.isPC?window.open(e.link.source):(t.file_info=e,void this.push("openAttachment",t))}},{key:"showQRCode",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=arguments[2],i={render:"image",crisp:!0,minVersion:1,ecLevel:"L",size:300,ratio:null,fill:"#333",back:"#fff",rounded:50,quiet:1,mode:"plain",mSize:30,mPosX:50,mPosY:50,label:"",fontname:"sans",fontcolor:"#333",image:null,title:null};t=a({},i,t,{text:e}),n&&f.isPC&&(t.ePos=this._getEventPosition(n)),this.push("showQRCode",t)}},{key:"scanQRCode",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return"boolean"!=typeof e.needResult&&(e.needResult=!0),this.send("scanQRCode",e)}},{key:"getLocation",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments[1],n=arguments[2],i={enableHighAccuracy:!0,timeout:5e3,maximumAge:1e4,convert:!0,title:"选择地址",placement:"left-bottom"};return e=a({},i,e),n&&f.isPC&&(e.ePos=this._getEventPosition(n)),this.send("getLocation",e,null,t)}},{key:"setPageConfig",value:function(e){this.push("setPageConfig",{config:e})}},{key:"installApplication",value:function(e){this.push("installApplication",{application_id:e})}},{key:"_init",value:function(e){var t=this;return this.send("init",{application_id:e}).then(function(n){return t._ticket=n.ticket,t._user=n.user,t._table=n.table||n.app,!t._table.app_id&&t._table.table_id&&(t._table.app_id=t._table.table_id),t._version=n.version,t.appId=e,a({},n,{app:t._table,table:t._table})})}},{key:"_getEventPosition",value:function(e){var t=e.currentTarget||e.target,n=t.getBoundingClientRect(),i=n.top,o=n.bottom,r=n.left,s=n.right,a=n.width,u=n.height;return{target:{top:i,bottom:o,left:r,right:s,width:a,height:u,offsetWidth:e.target.offsetWidth,offsetHeight:e.target.offsetHeight},clientX:e.clientX,clientY:e.clientY,offsetX:e.offsetX,offsetY:e.offsetY}}}]),t}(h["default"]);t["default"]=v,e.exports=t["default"]},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a=n(7),u=i(a),c=n(3),l=i(c),f=n(1),d=function(){function e(t){o(this,e),this.connect=(0,l["default"])(),this.promises={},this.handlers={},t&&this.on(t)}return s(e,[{key:"ready",value:function(e){return this.connect.promise.then(e),this}},{key:"on",value:function(e,t,n){var i=this,o=void 0;return t||"object"!=("undefined"==typeof e?"undefined":r(e))?o=[this._on(e,t,n)]:(o=[],Object.keys(e).forEach(function(t){o.push(i._on(t,e[t],n))})),{on:this.on.bind(this),revoke:o[0],revokes:o}}},{key:"_on",value:function(e,t,n){var i=this,o=function(){};return e&&t&&(!n&&this.handlers[e]||(this.handlers[e]=[]),this.handlers[e].push(t),o=function(){i.off(e,t)}),o}},{key:"off",value:function(e,t){if(e&&this.handlers[e])if(t){var n=this.handlers[e].indexOf(t);n>=0&&this.handlers[e].splice(n,1)}else this.handlers[e]=[];else"!"==e&&(this.handlers={});return this}},{key:"emit",value:function(e,t,n){var i=[],o=!1;if(e&&this.handlers[e]){var r=this.handlers[e];i=r.map(function(e){var i=void 0;return o||(i=e(t,n),!1===i&&(o=!0)),i})}return"*"!=e&&this.handlers["*"]&&(i=i.concat(this.handlers["*"].map(function(n){return n(e,t)}))),i}},{key:"push",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this.ready(function(){t._send(e,n)})}},{key:"send",value:function(e,t,n,i){var o=this,r=n||this._unique_id();if(this.ready(function(){o._send(e,t,r)}),i&&"function"==typeof i)return this.promises[r]=i,r;var s=(0,l["default"])();return this.promises[r]=s,s.promise}},{key:"handleMessage",value:function(e){var t=this;if(!1!==this._processMessage(e)){var n=void 0,i=void 0,o=void 0,r=void 0;try{if(n=e.data,"string"==typeof n&&((f.isIPhone||f.isIPad)&&(n=n.replace(/[\r\n\t]+/g,"")),n=JSON.parse(n)),!n.action&&!n.id&&!n.callback)throw new Error}catch(s){throw this.emit("error",{type:"json",source:n,err:s}),this.emit("error.json",{source:n,err:s}),alert("HB_APP_SDK: json parse fail\n"+n),new Error("HB_APP_SDK: malformed message")}if(i=n.id||n.callback,o=n.action,r=n.params||n.data,i){if(i in this.promises){var a=this.promises[i];a.resolve?(n.error?a.reject(n.error):n.result?a.resolve(n.result):a.reject({cancelled:!0}),this.promises[i]=null):n.result||n.error?this.promises[i](n.result,n.error):this.promises[i](null,{cancelled:!0})}else if(o&&this.handlers[o]){var u=function(e){t.send(o,e,i)};this.emit(o,r,u)}}else o?(this.emit(o,r),r&&r.action&&this.emit(o+"."+r.action,r.data)):this.emit("*",r)}}},{key:"destroy",value:function(){this.off("!"),this.connect=(0,l["default"])()}},{key:"_send",value:function(){}},{key:"_processMessage",value:function(e){return e}},{key:"_unique_id",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"cb_":arguments[0],t=arguments.length<=1||void 0===arguments[1]?10:arguments[1],n=arguments.length<=2||void 0===arguments[2]?16:arguments[2],i="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";return u["default"].generateUUID(e+i.substr(0,t),n)()}}]),e}();t["default"]=d,e.exports=t["default"]},function(e,t){function n(e,t){function n(){var t=(new Date).getTime(),n=i.length;return e.replace(/[xy]/g,function(e){var o=(t+Math.random()*n)%n|0;return t=Math.floor(t/n),i["x"===e?o:3&o|8]})}e="string"==typeof e?e:o,t="number"==typeof t?t:s;var i=r.slice(0,t);return n}var i,o="xxxxyxxxxyxxxxyxxxxy",r="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",s=16;i=n(),i.generateUUID=n,e.exports=i},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),u=function d(e,t,n){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,t);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:d(o,t,n)}if("value"in i)return i.value;var r=i.get;if(void 0!==r)return r.call(n)},c=n(5),l=i(c),f=function(e){function t(){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),a(t,[{key:"init",value:function(e){return this.connect.resolve(),window.HB=window.HB||{},window.HB.bridgeCallback=this.handleBridgeInvoke.bind(this,"callback"),window.HB.bridgeCancel=this.handleBridgeInvoke.bind(this,"cancel"),window.HB.bridgeEmit=this.handleBridgeInvoke.bind(this,"emit"),this._init(e)}},{key:"_send",value:function(e,t,n){var i=["huoban://hybrid?action="+encodeURIComponent(e)];n&&i.push("callback="+encodeURIComponent(n)),t&&i.push("params="+encodeURIComponent(JSON.stringify(t)));var o=i.join("&");this._invokeNative(o)}},{key:"_invokeNative",value:function(e){var t=document.createElement("iframe");t.style.width=0,t.style.height=0,t.style.display="none",t.src=e,document.body.appendChild(t),setTimeout(function(){t.parentNode.removeChild(t)},100)}},{key:"handleBridgeInvoke",value:function(e,t){return this.handleMessage({data:t})}},{key:"destroy",value:function(){u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),delete window.HB.bridgeCallback,delete window.HB.bridgeCancel,delete window.HB.bridgeEmit}}]),t}(l["default"]);t["default"]=f,e.exports=t["default"]},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),u=n(8),c=i(u),l=function(e){function t(){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),a(t,[{key:"_invokeNative",value:function(e){window.prompt(e,"")}}]),t}(c["default"]);t["default"]=l,e.exports=t["default"]},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=function y(e,t,n){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,t);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:y(o,t,n)}if("value"in i)return i.value;var r=i.get;if(void 0!==r)return r.call(n)},l=n(3),f=i(l),d=n(1),p=n(6),h=i(p),v=function(e){function t(){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"init",value:function(){var e=this;this.heartbeatFrequency=5,this.connections={},this.handleHandshake=this._handleHandshake.bind(this),window.addEventListener("message",this.handleHandshake,!1),this.ready(function(t){e.runHeartbeatDetection()})}},{key:"runHeartbeatDetection",value:function(){var e=this;this.getPorts().forEach(function(t){var n=t.client,i=(t.port,t.lastPing);i&&e.now()-i>2*e.heartbeatFrequency*1e3?(console.log("close",n,(e.now()-i)/1e3),e._close(n)):e.push(n,d.MSG_TYPES.PING)}),setTimeout(function(t){e.runHeartbeatDetection()},1e3*this.heartbeatFrequency)}},{key:"destroy",value:function(e){var n=this;c(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.getPorts().forEach(function(e){var t=e.client;n._close(t)}),this.connections={},e&&window.removeEventListener("message",this.handleHandshake)}},{key:"_close",value:function(e){this.connections[e]&&(this.connections[e].port.close(),this.connections[e].port.onmessage=null,delete this.connections[e])}},{key:"now",value:function(){return Date.now()}},{key:"report",value:function(){var e=0,t=this.getPorts().reduce(function(t,n){return e++,t[n.application_id]||(t[n.application_id]=0),t[n.application_id]++,t},{}),n=Object.keys(t);console.log("当前已连接应用数：",n.length,", 已连接页面总数：",e,", 应用计数统计：",t)}},{key:"getPorts",value:function(e){var t=this;return Object.keys(this.connections).reduce(function(n,i){return e&&t.connections[i].application_id!=e||n.push(t.connections[i]),n},[])}},{key:"_handleHandshake",value:function(e){var t=this,n=e.data&&e.data.split?e.data.split(":"):[];if(3==n.length&&n[0]==d.MSG_TYPES.CONNECT&&e.ports.length){var i=function(){var i=n[1],o=n[2];if(!i||t.getPorts(i).length>=10)return e.ports[0].postMessage({action:d.MSG_TYPES.CONNECT,data:{error:{message:"Too many connections"}}}),{v:void 0};t.connections[o]={client:o,application_id:i,port:e.ports[0]};var r=function(e,n){n?(t.connections[o]&&t._send(o,d.MSG_TYPES.CONNECT,{error:{message:n}}),delete t.connections[o]):(t.connections[o].port.onmessage=t.handlePortMessage.bind(t,o),t.connect.resolve(o),t.push(o,d.MSG_TYPES.CONNECT,{result:{message:e}}))};t.emit("connect",{application_id:i,origin:e.origin,client:o},r)}();if("object"===("undefined"==typeof i?"undefined":a(i)))return i.v}}},{key:"send",value:function(e,t,n,i){var o=this,r=i||this._unique_id("h_");this.ready(function(){o._send(e,t,n,r)});var s=(0,f["default"])();return this.promises[r]=s,s.promise}},{key:"push",value:function(e,t){var n=this,i=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.ready(function(){n._send(e,t,i)})}},{key:"_send",value:function(e,t,n,i){if(this.connections[e]){var o={action:t};n&&(o.data=n),i&&(o.id=i),this.connections[e].port.postMessage(o)}else this.emit("error",{type:"send",data:{message:"连接不存在"}})}},{key:"handlePortMessage",value:function(e,t){var n=this;if(!1!==this._processMessage(t,e)){if(!this.connections[e])throw new Error("message client error: "+e);var i=void 0,o=void 0,r=void 0;try{if(i=t.data,"string"==typeof i&&(i=JSON.parse(i)),!i.action&&!i.id&&i.callback)throw new Error}catch(s){throw new Error("HB_APP_SDK: malformed message")}o=i.id||i.callback,r=i.action;var a=void 0;o&&(a=function(t,i){i?n.connections[e].port.postMessage({id:o,error:i}):n.connections[e].port.postMessage({id:o,result:t})}),this.emit(r,{application_id:parseInt(this.connections[e].application_id,10),params:i.data},a)}}},{key:"_processMessage",value:function(e,t){switch(e.data.action){case d.MSG_TYPES.DISCONNECT:return this._close(t),!1;case d.MSG_TYPES.BROADCAST:return this._broadcast(this.connections[t].application_id,e.data.data,[t]),!1;case d.MSG_TYPES.PING:return this.connections[t].lastPing=this.now(),!1}}},{key:"broadcast",value:function(e,t){var n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this._broadcast(n,t?{action:e,data:t}:{action:e})}},{key:"_broadcast",value:function(e,t){var n=this,i=arguments.length<=2||void 0===arguments[2]?[]:arguments[2];this.getPorts(e).forEach(function(e){var o=e.client;e.port;i.indexOf(o)===-1&&n.push(o,d.MSG_TYPES.BROADCAST,t)})}}]),t}(h["default"]);t["default"]=v,e.exports=t["default"]}])});
//# sourceMappingURL=HuobanAppSDK.min.js.map